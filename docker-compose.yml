services:
  # ─── 0) db_setup_service (runs db_setup.py once) ──────────────────────────────
  db_setup_service:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["db_setup.py"]
    networks:
      - bcnet
    volumes:
      - db_data:/data
    # Remove container after completion
    restart: "no"

  # ─── 1) requester_service (bootstrap) ─────────────────────────────────────────
  master_service:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - ROLE=master
      - PORT=5002
      - BOOTSTRAP_HOST=master_service
      - BOOTSTRAP_PORT=5002
    command: ["master.py", "5002"]
    networks:
      - bcnet
    depends_on:
      db_setup_service:
        condition: service_completed_successfully
    volumes:
      - db_data:/data
    healthcheck:
      start_period: 2s
      retries: 1
      test: ["CMD", "curl", "-f", "http://localhost:5002/chain"]
      timeout: 2s
      interval: 120s

  # ─── 2) requester_service ─────────────────────────────────────────────────
  requester_service:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - ROLE=requester
      - PORT=5003
      - BOOTSTRAP_HOST=master_service
      - BOOTSTRAP_PORT=5002
    command: ["-u", "requester.py", "5003"]
    networks:
      - bcnet
    depends_on:
      master_service:
        condition: service_healthy
      db_setup_service:
        condition: service_completed_successfully
    volumes:
      - db_data:/data

  provider_service:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - ROLE=provider
      - PORT=5004
      - BOOTSTRAP_HOST=master_service
      - BOOTSTRAP_PORT=5002
    command: ["-u", "provider.py", "5004"]
    ports:
      - "5004:5004"
    networks:
      - bcnet
    depends_on:
      master_service:
        condition: service_healthy
      db_setup_service:
        condition: service_completed_successfully
    volumes:
      - db_data:/data

networks:
  bcnet:
    driver: bridge

volumes:
  db_data: